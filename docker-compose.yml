services:
  harness:
    build: harness
    container_name: harness
    # ports:
    #   - "9464:9464" # metrics endpoint
    deploy:
      resources:
        limits:
          cpus: "4.0" # Limit cores
          memory: 512M # limit memory
    environment:
      - GOMAXPROCS=4 # Limit Go runtime
      - GATEWAY_HOSTNAME=gateway
    depends_on: [prometheus, grafana, gateway]
    networks:
      - monitoring

  gateway:
    build: services/gateway/
    container_name: gateway
    # ports:
    #   - "8080:8080" # gateway api endpoint
    deploy:
      resources:
        limits:
          cpus: "1.0" # Limit cores
          memory: 128M # limit memory
    environment:
      - GOMAXPROCS=1 # Limit Go runtime
      - ORCHESTRATOR_HOSTNAME=game-orchestrator
      - MATCHMAKING_HOST=matchmaking
      - MATCHMAKING_PORT=8081
    depends_on:
      - game-orchestrator
      - matchmaking
    networks:
      - monitoring

  game-orchestrator:
    build:
      context: .
      dockerfile: services/game-orchestrator/Dockerfile
    container_name: game-orchestrator
    privileged: true
    environment:
      - DOCKER_TLS_CERTDIR=""
    networks:
      - monitoring

  matchmaking:
    build: services/matchmaking/
    container_name: matchmaking
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 128M
    environment:
      - REDIS_ADDR=redis:6379
      - ORCHESTRATOR_URL=http://game-orchestrator:8080
    depends_on:
      - redis
      - game-orchestrator
    networks:
      - monitoring

  redis:
    image: redis:7-alpine
    container_name: redis
    networks:
      - monitoring

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    networks:
      - monitoring

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    ports:
      - "3000:3000"
    networks:
      - monitoring
    depends_on:
      - prometheus

networks:
  monitoring:
    driver: bridge
