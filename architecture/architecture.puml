@startuml
skinparam defaultFontName "Segoe UI"
skinparam roundcorner 10
skinparam shadowing true
skinparam linetype ortho

skinparam component {
  BackgroundColor #FDFDFD
  BorderColor #333333
  ArrowColor #333333
  FontSize 13
}

skinparam database {
  BackgroundColor #FDFDFD
  BorderColor #333333
}

skinparam package {
  BackgroundColor #F5F5F5
  BorderColor #666666
}

skinparam note {
  BackgroundColor #FFFACD
  BorderColor #DAA520
}

title Matchmaking Simulation - System Architecture

package "Load Generation (Harness)" {
    component "Compositor" as Compositor <<Logic>>
    component "Player Pool" as Pool <<Manager>>
    collections "Player\nGoroutines" as Players <<Simulation>>

    Compositor --> Pool : "Calculates rates\n& dispatches"
    Pool --> Players : "Spawns & Monitors"
}

component "Gateway" as Gateway <<Reverse Proxy>> {
}

package "Matchmaking Domain" {
    component "Matchmaking API" as MatchAPI <<Service>>
    component "Matchmaker\nWorker" as MatchWorker <<Background Process>>
}

package "Game Infrastructure" {
    component "Game Orchestrator" as Orchestrator <<Service>>
    collections "Game Server\nContainers" as GameServers <<Ephemeral>>
}

database "Redis" as Redis {
    [Queue List] as R_Queue
    [Ticket Hash] as R_Ticket
    [Match Hash] as R_Match
}

package "Observability" {
    component "Prometheus" as Prometheus <<Metrics DB>>
    component "Grafana" as Grafana <<Visualization>>
}

' Traffic Flows
Players -down-> Gateway : "REST API\n(Join, Status)"
Gateway -down-> MatchAPI : "Forward Request"

' Matchmaking Flows
MatchAPI -right-> R_Ticket : "Create Ticket\n(Pending)"
MatchAPI -right-> R_Queue : "Push Ticket ID"

MatchWorker ..> R_Queue : "Poll (Lua Batch)"
MatchWorker ..> R_Ticket : "Fetch/Update"
MatchWorker -down-> Orchestrator : "POST /create\n(Provision Server)"

' Orchestration Flows
Orchestrator --> GameServers : "Docker API\n(Run Container)"
Orchestrator -right-> MatchWorker : "Return Connection Info"

MatchWorker --> R_Match : "Create Match Record"
MatchWorker --> R_Ticket : "Update (Matched)"

' Game Play Flows
Players -down-> Orchestrator : "WS Connect\n(via Proxy)"
Orchestrator -down-> GameServers : "Proxy Traffic"

' Monitoring Flows
Prometheus ..> Gateway : "Scrape /metrics"
Prometheus ..> MatchAPI : "Scrape /metrics"
Prometheus ..> Orchestrator : "Scrape /metrics"
Prometheus ..> "Load Generation (Harness)" : "Scrape /metrics" 
Grafana ..> Prometheus : "Query"

note left of Compositor
  <b>Compositor</b>
  Controls simulation pacing
  by assigning scenarios per second.
end note

note right of MatchWorker
  <b>Worker Logic</b>
  1. Pop batch from Redis
  2. Group players (FIFO)
  3. Request server from Orchestrator
  4. Update Redis state
end note

note bottom of Orchestrator
  <b>Privileged Mode</b>
  Accesses Docker Socket to
  spawn sibling containers
  for Game Servers.
end note

@enduml
