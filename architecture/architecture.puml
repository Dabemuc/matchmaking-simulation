@startuml
skinparam defaultFontName "Segoe UI"
skinparam roundcorner 10
skinparam shadowing true
skinparam linetype ortho
skinparam nodesep 60
skinparam ranksep 60

skinparam component {
  BackgroundColor #FDFDFD
  BorderColor #333333
  ArrowColor #333333
  FontSize 13
}

skinparam database {
  BackgroundColor #FDFDFD
  BorderColor #333333
}

skinparam package {
  BackgroundColor #F5F5F5
  BorderColor #666666
}

skinparam note {
  BackgroundColor #FFFACD
  BorderColor #DAA520
}

title Matchmaking Simulation - System Architecture

' --- Top: Observability ---
package "Observability" {
    component "Grafana" as Grafana <<Visualization>>
    component "Prometheus" as Prometheus <<Metrics DB>>
    Grafana -down-> Prometheus : "Query"
}

' --- Left: Load Generation ---
package "Load Generation (Harness)" {
    component "Compositor" as Compositor <<Logic>>
    component "Player Pool" as Pool <<Manager>>
    collections "Player\nGoroutines" as Players <<Simulation>>

    Compositor -down-> Pool : "Calculates rates\n& dispatches"
    Pool -down-> Players : "Spawns & Monitors"
}

' --- Center: Gateway ---
component "Gateway" as Gateway <<Reverse Proxy>>

' --- Right: Matchmaking Domain ---
package "Matchmaking Domain" {
    component "Matchmaking API" as MatchAPI <<Service>>
    component "Matchmaker\nWorker" as MatchWorker <<Background Process>>

    MatchAPI -[hidden]down- MatchWorker
}

' --- Far Right: Redis ---
database "Redis" as Redis {
    [Ticket Hash] as R_Ticket
    [Queue List] as R_Queue
    [Match Hash] as R_Match

    R_Ticket -[hidden]down- R_Queue
    R_Queue -[hidden]down- R_Match
}

' --- Bottom Center: Game Infrastructure ---
package "Game Infrastructure" {
    component "Game Orchestrator" as Orchestrator <<Service>>
    collections "Game Server\nContainers" as GameServers <<Ephemeral>>

    Orchestrator -down-> GameServers : "Docker API\n(Run Container)"
}

' --- Alignment / Layout Helpers ---

' Vertical alignment for Game Infrastructure
Gateway -[hidden]down- Orchestrator

' --- Connections ---

' Load Gen Traffic
Players -right-> Gateway : "REST API\n(Join, Status)"
Gateway -right-> MatchAPI : "Forward Request"

' Matchmaking API -> Redis
MatchAPI -right-> R_Ticket : "Create Ticket\n(Pending)"
MatchAPI -right-> R_Queue : "Push Ticket ID"

' MatchWorker Logic
MatchWorker .right.> R_Queue : "Poll (Lua Batch)"
MatchWorker .up.> R_Ticket : "Fetch/Update"
MatchWorker -right-> R_Match : "Create Match Record"
MatchWorker -left-> Orchestrator : "POST /create\n(Provision Server)"

' Orchestrator
Orchestrator .right.> MatchWorker : "Return Connection Info"
Orchestrator -down-> GameServers : "Proxy Traffic"

' Player -> Game Connection
Players -down-> Orchestrator : "WS Connect\n(via Proxy)"

' Observability Scrapes
Prometheus .down.> Gateway : "Scrape /metrics"
Prometheus .down.> MatchAPI : "Scrape /metrics"
Prometheus .down.> Orchestrator : "Scrape /metrics"
Prometheus .left.> Compositor : "Scrape /metrics"

' Notes
note right of Compositor
  <b>Compositor</b>
  Controls simulation pacing
  by assigning scenarios per second.
end note

note bottom of MatchWorker
  <b>Worker Logic</b>
  1. Pop batch from Redis
  2. Group players (FIFO)
  3. Request server from Orchestrator
  4. Update Redis state
end note

note bottom of Orchestrator
  <b>Privileged Mode</b>
  Accesses Docker Socket to
  spawn sibling containers
  for Game Servers.
end note

@enduml
